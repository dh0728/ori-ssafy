# ğŸŒ Spring Cloud Gateway

## ğŸŒ API Gateway ë€? 

![alt text](image-2.png)

- ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê´€ë¦¬ / ìš´ì˜ì„ ìœ„í•œ í”Œë«í¼ íŒ¨í„´ì´ë©° í•´ë‹¹ íŒ¨í„´ì— í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•˜ëŠ” ì„œë²„
- API ê²Œì´íŠ¸ì›¨ì´ëŠ” ê°œë³„ ì„œë¹„ìŠ¤ì˜ ì• ë‹¨ì—ì„œ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë‹¨ì¼í™”í•˜ê³  ë‹¤ìŒê³¼ ê°™ì€ í•„ìˆ˜ ê¸°ëŠ¥ ìš”ì†Œë“¤ì„ ì œê³µ

### ğŸ”– API Gateway íŠ¹ì§•
- **ì¸ì¦ê³¼ ì¸ê°€** : ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì— ëŒ€í•œ ì ‘ê·¼ì— ìˆì–´ì„œ ë‹¨ì¼ ì§„ì…ì ì—ì„œ ì¸ì¦ê³¼ ì¸ê°€ ì²˜ë¦¬ë¥¼ ì§„í–‰
- **API ìš”ì²­ ë¡œë“œë°¸ëŸ°ì‹± ë° ë¼ìš°íŒ…** : API ìš”ì²­ì„ ì‹ë³„í•˜ì—¬ ì ì ˆí•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ì „ë‹¬
- **QoS(Quality of Service)** : ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ ì œê³µ ë° ë„¤íŠ¸ì›Œí¬ í’ˆì§ˆì„ ê´€ë¦¬í•˜ë©° ì‚¬ìš©ì / í´ë¼ì´ì–¸íŠ¸ / API ë‹¨ìœ„ë¡œ ì ‘ì† ì œì–´
- **ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§** : API ìš”ì²­ì— ëŒ€í•œ ë¡œê¹… / ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ ì§€ì›
- **ì…ë ¥ ìœ íš¨ì„± ê²€ì‚¬** : API ìš”ì²­ì˜ ì ì ˆí•œ í˜•ì‹ê³¼ í•„ìˆ˜ ë°ì´í„° í¬í•¨ ì—¬ë¶€ë¥¼ ì‹ë³„ ë° ê´€ë¦¬

### ğŸ”– API ê²Œì´íŠ¸ì›¨ì´ì˜ ì¥ë‹¨ì 
#### ì¥ì 
- **ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ìº¡ìŠí™”** : í´ë¼ì´ì–¸íŠ¸ëŠ” íŠ¹ì • ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  ë‹¨ìˆœíˆ ê²Œì´íŠ¸ì›¨ì´ì™€ í†µì‹ í•˜ë©°, API ê²Œì´íŠ¸ì›¨ì´ëŠ” ê° ì¢…ë¥˜ì˜ í´ë¼ì´ì–¸íŠ¸ì— íŠ¹ì • APIë¥¼ ì œê³µ
- **í´ë¼ì´ì–¸íŠ¸ì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°„ì˜ ì™•ë³µ íšŸìˆ˜ê°€ ê°ì†Œí•˜ë©°, í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ë‹¨ìˆœí™”**

#### ë‹¨ì 
- **ê°œë°œ, ë°°í¬ ë° ê´€ë¦¬í•´ì•¼ í•˜ëŠ” ì§€ì ì´ ì¦ê°€**
- ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ Endpointë¥¼ ë…¸ì¶œí•˜ê¸° ìœ„í•´ API ê²Œì´íŠ¸ì›¨ì´ë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•˜ëŠ”ë° ì´ë¡œ ì¸í•´ **ê°œë°œ ë³‘ëª© í˜„ìƒì´ ë°œìƒí•  ìˆ˜ ìˆìŒ**

## ğŸŒ Spring Cloud Gatewayë€?
- Spring Cloud GatewayëŠ” Spring Frameworkì—ì„œ ì œê³µí•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ê¸°ë°˜ì˜ Gateway ì„œë¹„ìŠ¤
- Spring Cloud Gateway ì´ì „ì—ëŠ” Spring Cloud Zuulì´ ìˆì—ˆìœ¼ë©° Zuulì˜ íŒ¨ì¹˜ê°€ ì¤‘ë‹¨ë¨ì— ë”°ë¼ Spring Cloud Gatewayë¡œì˜ ì´ì „

#### Spring Cloud Zuul ê³¼ Spring Cloud Gatewayì˜ ì°¨ì´ì 
- **ê¸°ë°˜ ì›¹ ì„œë²„** : Zuulì€ Tomcat, Spring Cloud Gateway(ì´í•˜ SCG)ëŠ” Netty
- **ë™ê¸° / ë¹„ë™ê¸° ë°©ì‹** : Zuulì€ ë™ê¸° ë°©ì‹, NettyëŠ” ë¹„ë™ê¸° ë°©ì‹
- **ì›¹ í”„ë ˆì„ì›Œí¬** : Zuulì€ Spring WEB MVC ê¸°ë°˜ì´ì§€ë§Œ SCGëŠ” Spring WebFlux ê¸°ë°˜

### ğŸ”– Spring Cloud ì•„í‚¤í…ì²˜ì™€ íŠ¹ì§•

![alt text](image-3.png)

- Spring Cloud Gatewayë¥¼ êµ¬ì„±í•˜ëŠ” ì£¼ìš” 3ìš”ì†Œë¡œëŠ” **Route, Predicate, Filters**ê°€ ìˆìœ¼ë©° ì‚¬ìš©ìì˜ ìš”ì²­ì´ ê° ì»´í¬ë„ŒíŠ¸ë¥¼ ê±°ì³ ë¼ìš°íŒ…ë©ë‹ˆë‹¤.

#### Route
- **Route**ëŠ” **ê³ ìœ  ID + ëª©ì ì§€ URI + Predicate + Filter**ë¡œ êµ¬ì„±ë˜ë©°, ì•„ë˜ì—ì„œ ì†Œê°œí•  Predicate + Filterì˜ ë¬¶ìŒì´ì ë¼ìš°íŒ…ì´ ë  ê·œì¹™
- Routeë¥¼ í†µí•´ SCGë¡œ ìš”ì²­ëœ URIì˜ ì¡°ê±´ì´ Predicateë¥¼ í†µê³¼í•˜ì—¬ ì°¸ì¸ ê²½ìš° ë§¤í•‘ëœ í•´ë‹¹ ê²½ë¡œë¡œ ë§¤ì¹­


#### Predicate
- **PredicateëŠ” ì£¼ì–´ì§„ ìš”ì²­ì´ ì£¼ì–´ì§„ ì¡°ê±´ì„ ì¶©ì¡±í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ëŠ” êµ¬ì„± ìš”ì†Œ**ì´ë©°, í•˜ë‚˜ ì´ìƒì˜ ì¡°ê±´ìë¥¼ ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë§Œì•½ Predicateì— ë§¤ì¹­ë˜ì§€ ì•Šì„ ê²½ìš° SCG ìì²´ì ìœ¼ë¡œ HTTP 404 Not Foundë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.
- í¬ê²Œ **ì‹œê°„ / URI / ìš”ì²­ / ë„¤íŠ¸ì›Œí¬** ê´€ë ¨ìœ¼ë¡œ ë¶„ë¥˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì‹œê°„ ê´€ë ¨**
- Before : ìš”ì²­ì´ íŠ¹ì • ì‹œê°„ëŒ€ ì´ì „ì— ë“¤ì–´ì˜¨ ê²ƒì¸ì§€ í™•ì¸
- After : ìš”ì²­ì´ íŠ¹ì • ì‹œê°„ëŒ€ ì´í›„ì— ë“¤ì–´ì˜¨ ê²ƒì¸ì§€ í™•ì¸
- Between : ìš”ì²­ì´ íŠ¹ì • ì‹œê°„ëŒ€ ì‚¬ì´ì— ë“¤ì–´ì˜¨ ê²ƒì¸ì§€ í™•ì¸

**URI ê´€ë ¨**
- Path : ìš”ì²­ì´ íŠ¹ì • ê²½ë¡œë¡œ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
- Query : ìš”ì²­ì— íŠ¹ì • íŒŒë¼ë¯¸í„°ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

**ìš”ì²­ ê´€ë ¨**
- Cookie : ìš”ì²­ì— íŠ¹ì • ì¿ í‚¤ê°€ ë‹´ê²¨ ìˆëŠ”ì§€ í™•ì¸
- Header : ìš”ì²­ì— íŠ¹ì • í—¤ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
- Method : ìš”ì²­ì´ íŠ¹ì • HTTP ë©”ì„œë“œë¡œ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
- Weight : ì „ì²´ íŠ¸ë˜í”½ì— ëŒ€í•´ ê·¸ë£¹ë³„ ê°€ì¤‘ì¹˜ë¥¼ ë‘ì–´ ê·¸ë£¹ë³„ë¡œ ìš”ì²­ì„ ë¶„ì‚°ì‹œí‚´

**ë„¤íŠ¸ì›Œí¬ ê´€ë ¨**
- Host : ìš”ì²­ì´ íŠ¹ì • í˜¸ìŠ¤íŠ¸ë¡œ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
- RemoteAddr : ìš”ì²­ì´ íŠ¹ì • ì›ê²© ì£¼ì†Œë¡œ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
    - SCGê°€ í”„ë¡ì‹œ ê³„ì¸µ ë’¤ì— ìˆìœ¼ë©´ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IP ì£¼ì†Œì™€ ì¼ì¹˜í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
    - ì´ ê²½ìš° ì‚¬ìš©ì ì§€ì •ì„ ì„¤ì •í•˜ì—¬ ì›ê²© ì£¼ì†Œë¥¼ í™•ì¸í•˜ëŠ” ë°©ë²•ì„ ì„¤ì •í•  ìˆ˜ ìˆìŒ (RemoteAddressResolver, XForwaredRemoteAddressResolver)


#### Filter & Filter Chain
- **Filter & Filter Chainì€ SCGë¥¼ í†µí•´ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì´ë‚˜ ë°˜í™˜ë˜ëŠ” ì‘ë‹µì— ëŒ€í•´ ì „ì²˜ë¦¬ / í›„ì²˜ë¦¬**ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.
- ì´ ì¤‘ì—ì„œ Proxy FilterëŠ” í”„ë¡ì‹œ ìš”ì²­ì´ ì²˜ë¦¬ë  ë–„ ìˆ˜í–‰ë˜ëŠ” í•„í„°ì…ë‹ˆë‹¤.
- ì • Routeì— ì ìš©í•  ìˆ˜ ìˆëŠ” Gateway Filterì™€ ì „ì—­ì ìœ¼ë¡œ ì ìš©ë˜ëŠ” Global Filterë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.

**Gateway Filter**
ìš”ì²­ / ì‘ë‹µ ê´€ë ¨
- AddRequestHeader / AddResponseHeader : ìš”ì²­ / ì‘ë‹µ í—¤ë”ë¥¼ ì¶”ê°€
- AddRequestParameter : ìš”ì²­ ì‹œ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€
- RemoveRequestHeader / RemoveResponseHeader : ìš”ì²­ / ì‘ë‹µ í—¤ë”ë¥¼ ì‚­ì œ
- RemoveRequestParameter : ìš”ì²­ ì‹œ íŒŒë¼ë¯¸í„°ë¥¼ ì‚­ì œ
- DedupeResponseHeader : ì´ë¦„ì´ ê³µë°±ì¸ í—¤ë” ì´ë¦„ ëª©ë¡ì„ í¬í•¨í•  ìˆ˜ ìˆìŒ
- MapRequestHeader : ìƒˆë¡­ê²Œ ëª…ëª…ëœ í—¤ë”ë¥¼ ë§Œë“¤ê³  ê¸°ì¡´ì— ë“¤ì–´ì˜¨ ìš”ì²­ì— ëª…ëª…ëœ í—¤ë”ì—ì„œ ê°’ì„ ì¶”ì¶œí•˜ì—¬ ë„£ìŒ
- PrefixPath : ëª¨ë“  ìš”ì²­ì˜ ê²½ë¡œì— ì ‘ë‘ì‚¬ë¥¼ ë¶™ì¼ ìˆ˜ ìˆìŒ
- RewritePath : íŠ¹ì • ê²½ë¡œë¥¼ ìƒˆ ê²½ë¡œë¡œ ë³€í™˜
- RewriteLocationResponseHeader : ì‘ë‹µ í—¤ë”ì˜ ê°’ ì¤‘ Locationì„ ìˆ˜ì •
- RewriteResponseHeader : ì‘ë‹µ í—¤ë” ê°’ì„ ìˆ˜ì •
- RedirectTo : 300ë²ˆëŒ€ HTTP ìƒíƒœê°’ì— ëŒ€í•´ íŠ¹ì • URIë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
- SaveSession : Spring Session ì‚¬ìš© ì‹œ ìœ ìš©í•˜ë©° ì „ë‹¬ëœ í˜¸ì¶œì„ ë§Œë“¤ê¸° ì „ì— ì„¸ì…˜ ìƒíƒœê°€ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
- SecureHeaders : ê°ì¢… ë³´ì•ˆ ê´€ë ¨ í—¤ë”ë¥¼ ì¶”ê°€
- SetPath : ìš”ì²­ ê²½ë¡œë¥¼ íŠ¹ì • ê²½ë¡œë¡œ ë³€ê²½, í…œí”Œë¦¿ ì„¸ê·¸ë¨¼íŠ¸ í—ˆìš©
- SetRequestHeader / SetResponseHeader : ìš”ì²­ / ì‘ë‹µ í—¤ë”ë¥¼ ì§€ì •ëœ ì´ë¦„ìœ¼ë¡œ ëŒ€ì²´í•¨
- SetStatus : íŠ¹ì • HTTP ìƒíƒœë¡œ ì„¤ì •
- StripPrefix : ìš”ì²­ì—ì„œ íŠ¹ì • ìˆ˜ë§Œí¼ ê²½ë¡œë¥¼ ì œê±°í•¨
- Retry : ì¬ì‹œë„í•´ì•¼ í•˜ëŠ” íšŸìˆ˜, ìƒíƒœ, ë©”ì„œë“œ, ì˜ˆì™¸, ë°±ì˜¤í”„ ë“±ì„ ì„¤ì •
- RequestSize : ìš”ì²­ í¬ê¸°ê°€ í—ˆìš© ê°€ëŠ¥í•œ í•œë„ë³´ë‹¤ í°ì§€ ì²´í¬
- SetRequestHost : ê¸°ì¡´ í˜¸ìŠ¤íŠ¸ í—¤ë”ë¥¼ ì§€ì •ëœ ê°’ìœ¼ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆìŒ

ì˜ˆì™¸ ê´€ë ¨
- CircuitBreaker : Spring Cloud Circuit Breaker ì—°ë™, ê²Œì´íŠ¸ì›¨ì´ ê²½ë¡œë¥¼ Circuit Breakerë¡œ ë˜í•‘í•¨
- FallbackHeaders : FallbackHeadersì— ì „ë‹¬ëœ ìš”ì²­ì˜ í—¤ë”ì— Circuit Breaker ì‹¤í–‰ ì˜ˆì™¸ ì„¸ë¶€ ì •ë³´ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŒ

ë„¤íŠ¸ì›Œí¬ ê´€ë ¨
- PreserveHostHeader : HTTP í´ë¼ì´ì–¸íŠ¸ê°€ ê²°ì •í•œ í˜¸ìŠ¤íŠ¸ í—¤ë”ê°€ ì•„ë‹Œ ì›ë˜ í˜¸ìŠ¤íŠ¸ í—¤ë”ë¥¼ ë³´ë‚´ì•¼í•˜ëŠ”ì§€ ê²°ì •í•˜ê¸° ìœ„í•´ ë¼ìš°íŒ… í•„í„°ê°€ ê²€ì‚¬í•˜ëŠ” ìš”ì²­ ì†ì„±ì„ ì„¤ì •

ë¶€í•˜ ì²˜ë¦¬ ê´€ë ¨
- RequestRateLimiter : RateLimiterë¥¼ í†µí•´ í˜„ì¬ ìš”ì²­ì„ ì§„í–‰í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸, ì§„í–‰í•  ìˆ˜ ì—†ì„ ê²½ìš° HTTP 429 - Too Many Requests ìƒíƒœê°€ ë°˜í™˜ë¨

ê¸°ë³¸ í•„í„° : ëª¨ë“  ê²½ë¡œì— ì ìš©í•˜ê¸° ìœ„í•œ í•„í„°ë¥¼ default-filtersì— ë¬¶ì–´ì„œ ì§€ì •

Global Filter
- LoadBalancerClientFilter : URLì— lb ì²´ê³„ê°€ ìˆëŠ” ê²½ìš° Spring Cloudë¥¼ ì‚¬ìš©í•˜ì—¬ LoadBalancerClient ì´ë¦„ì„ ì‹¤ì œ í˜¸ìŠ¤íŠ¸ ë° í¬íŠ¸ë¡œ í™•ì¸í•˜ê³  ë™ì¼í•œ ì†ì„±ì˜ URIë¥¼ ë°”ê¿ˆ
- ReactiveLoadBalancerClientFilter
- WebClientHttpRoutingFilter
- NettyWriteResponseFilter
- RouteToRequestUrlFilter
- GatewayMetricFilter : Spring Boot Actuatorì™€ ì—°ê²°, spring.cloud.gateway.metrics.enabled ì†ì„± ì„¤ì • ì‹œ ì‘ë™ë¨. ë‹¤ìŒ ì§€í‘œê°€ Actuatorì— ì¶”ê°€ë¨
    - routeId : ê²½ë¡œ ID
    - routeUri : APIê°€ ë¼ìš°íŒ… ë˜ëŠ” URI
    - outcome
    - status
    - httpStatusCode
    - httpMethod


ì˜ˆì‹œ (application.yaml)
```
spring:
  cloud:
    gateway:
      # ë¨¼ì € ì„ ì–¸í•œ ìˆœì„œëŒ€ë¡œ í•„í„°ê°€ ì ìš©ë¨ route 1 -> route 2
      routes:
      	# route 1, routeì˜ idëŠ” sample-internal
        - id: sample-internal
          uri: http://localhost:8081
          predicates:
            - Path=/sample/api/v1/internal/** # /sample/api/v1/internal/** ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ë°˜ì‘
          filters:
            - NotAllowedURIExceptionFilter # filter ë¡œì§ ì ìš© (ì»¤ìŠ¤í…€ í•„í„°)
        # route 2, routeì˜ idëŠ” sample
        - id: sample
          uri: http://localhost:8081
          predicates:
            - Path=/sample/** # /sample/** ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ë°˜ì‘
          filters:
            - RewritePath=/sample/(?<segment>.*), /$\{segment} # filter ë¡œì§ ì ìš© (RewritePath í•„í„°)
```



## ğŸŒ Eureka

![alt text](image-4.png)

## ğŸŒ Feign Client
<a href="https://velog.io/@mrcocoball2/Spring-Cloud-Spring-Cloud-Gateway-%EA%B8%B0%EB%B3%B8-%EA%B0%9C%EB%85%90">[Spring Cloud] Spring Cloud Gateway - ê¸°ë³¸ ê°œë…</a>
<a href="https://techblog.lotteon.com/%EB%89%B4%EC%98%A8%EC%9D%B4%EB%93%A4%EC%9D%98-%EC%B2%AB-msa-%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%8F%84%EC%A0%84%EA%B8%B0-d336186a7e31">ì‹ ì…ì‚¬ì› ê°œë°œ ì •ë³µê¸° #2. KOKODOì˜ ì²« MSA ì„œë¹„ìŠ¤ ë„ì „ê¸°</a>

